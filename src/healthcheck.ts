import { type Config, Status } from "./index.js";
import osu from "node-os-utils";

export const healthcheckHandler = async (
  headers: Record<string, string | undefined>,
  config: Config
) => {
  const acceptHeader = headers["accept"];
  let status: Status = Status.pass;
  let checks = {
    memory: 0,
  };

  if (config.checks.memory_usage) {
    const memory = await osu.mem.info();
    checks.memory = memory.usedMemPercentage;
  }

  if (acceptHeader && acceptHeader.includes("text/html")) {
    return {
      type: "text/html",
      body: `
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Health Check</title>
            </head>
            <body>
              <h1>Health Check: ${status}</h1>
              <p>Your application is running smoothly! ${checks.memory}</p>
            </body>
            </html>
          `,
    };
  } else {
    return {
      type: "application/json",
      body: JSON.stringify({
        status,
        description: "Health check response, generated by allgood.",
        checks,
      }),
    };
  }
};
