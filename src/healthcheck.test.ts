import { healthcheckHandler } from './healthcheck.js';
import { Status } from './index.js';
import * as cache from './checks/cache.js';
import * as cpu from './checks/cpu.js';
import * as db from './checks/db.js';
import * as disk from './checks/disk.js';
import * as egress from './checks/egress.js';
import * as memory from './checks/memory.js';

jest.mock('./checks/cache.js');
jest.mock('./checks/cpu.js');
jest.mock('./checks/db.js');
jest.mock('./checks/disk.js');
jest.mock('./checks/egress.js');
jest.mock('./checks/memory.js');

describe('healthcheckHandler', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('JSON response format', () => {
    it('should return JSON response when accept header is not specified', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory usage is acceptable',
        value: '50%',
        time: 10,
      });

      const result = await healthcheckHandler(
        {},
        {
          checks: {
            memory_usage: true,
          },
        }
      );

      expect(result.type).toBe('application/json');
      expect(JSON.parse(result.body)).toEqual({
        status: Status.pass,
        description: 'Health check response, generated by allgood.',
        results: {
          memory_usage: {
            componentName: 'memory',
            status: Status.pass,
            message: 'Memory usage is acceptable',
            value: '50%',
            time: 10,
          },
        },
      });
    });

    it('should return JSON response when accept header does not include text/html', async () => {
      (cpu.cpuCheck as jest.Mock).mockResolvedValue({
        componentName: 'cpu',
        status: Status.pass,
        message: 'CPU usage is below 80%',
        value: '45%',
        time: 15,
      });

      const result = await healthcheckHandler(
        { accept: 'application/json' },
        {
          checks: {
            cpu_usage: true,
          },
        }
      );

      expect(result.type).toBe('application/json');
      const body = JSON.parse(result.body);
      expect(body.status).toBe(Status.pass);
      expect(body.results.cpu_usage).toBeDefined();
    });

    it('should return overall fail status when any check fails', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory usage is acceptable',
        value: '50%',
        time: 10,
      });

      (disk.disk as jest.Mock).mockResolvedValue({
        componentName: 'disk',
        status: Status.fail,
        message: 'Disk space is low',
        value: '95%',
        time: 20,
      });

      const result = await healthcheckHandler(
        {},
        {
          checks: {
            memory_usage: true,
            disk_space: true,
          },
        }
      );

      const body = JSON.parse(result.body);
      expect(body.status).toBe(Status.fail);
      expect(body.results.memory_usage).toBeDefined();
      expect(body.results.disk_space).toBeDefined();
    });

    it('should return overall warn status when any check warns', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory usage is acceptable',
        value: '50%',
        time: 10,
      });

      (cpu.cpuCheck as jest.Mock).mockResolvedValue({
        componentName: 'cpu',
        status: Status.warn,
        message: 'CPU usage is elevated',
        value: '75%',
        time: 15,
      });

      const result = await healthcheckHandler(
        {},
        {
          checks: {
            memory_usage: true,
            cpu_usage: true,
          },
        }
      );

      const body = JSON.parse(result.body);
      expect(body.status).toBe(Status.warn);
    });

    it('should handle multiple checks concurrently', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory OK',
        value: '50%',
        time: 10,
      });

      (cpu.cpuCheck as jest.Mock).mockResolvedValue({
        componentName: 'cpu',
        status: Status.pass,
        message: 'CPU OK',
        value: '45%',
        time: 15,
      });

      (disk.disk as jest.Mock).mockResolvedValue({
        componentName: 'disk',
        status: Status.pass,
        message: 'Disk OK',
        value: '60%',
        time: 20,
      });

      const result = await healthcheckHandler(
        {},
        {
          checks: {
            memory_usage: true,
            cpu_usage: true,
            disk_space: true,
          },
        }
      );

      const body = JSON.parse(result.body);
      expect(body.results.memory_usage).toBeDefined();
      expect(body.results.cpu_usage).toBeDefined();
      expect(body.results.disk_space).toBeDefined();
      expect(memory.memoryCheck).toHaveBeenCalled();
      expect(cpu.cpuCheck).toHaveBeenCalled();
      expect(disk.disk).toHaveBeenCalled();
    });

    it('should only run checks that are enabled', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory OK',
        value: '50%',
        time: 10,
      });

      const result = await healthcheckHandler(
        {},
        {
          checks: {
            memory_usage: true,
            cpu_usage: false,
            disk_space: false,
          },
        }
      );

      const body = JSON.parse(result.body);
      expect(body.results.memory_usage).toBeDefined();
      expect(body.results.cpu_usage).toBeUndefined();
      expect(body.results.disk_space).toBeUndefined();
      expect(memory.memoryCheck).toHaveBeenCalled();
      expect(cpu.cpuCheck).not.toHaveBeenCalled();
      expect(disk.disk).not.toHaveBeenCalled();
    });

    it('should handle all check types', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory OK',
        value: '50%',
        time: 10,
      });

      (egress.egress as jest.Mock).mockResolvedValue({
        componentName: 'egress',
        status: Status.pass,
        message: 'Egress OK',
        value: 'true',
        time: 100,
      });

      (disk.disk as jest.Mock).mockResolvedValue({
        componentName: 'disk',
        status: Status.pass,
        message: 'Disk OK',
        value: '60%',
        time: 20,
      });

      (cache.cacheConnection as jest.Mock).mockResolvedValue({
        componentName: 'cache_connection',
        status: Status.pass,
        message: 'Cache OK',
        value: 'true',
        time: 50,
      });

      (db.dbConnection as jest.Mock).mockResolvedValue({
        componentName: 'db_connection',
        status: Status.pass,
        message: 'DB OK',
        value: 'true',
        time: 75,
      });

      (cpu.cpuCheck as jest.Mock).mockResolvedValue({
        componentName: 'cpu',
        status: Status.pass,
        message: 'CPU OK',
        value: '45%',
        time: 15,
      });

      const result = await healthcheckHandler(
        {},
        {
          checks: {
            memory_usage: true,
            outbound_internet: true,
            disk_space: true,
            cache_connection: true,
            db_connection: true,
            cpu_usage: true,
          },
        }
      );

      const body = JSON.parse(result.body);
      expect(body.results.memory_usage).toBeDefined();
      expect(body.results.outbound_internet).toBeDefined();
      expect(body.results.disk_space).toBeDefined();
      expect(body.results.cache_connection).toBeDefined();
      expect(body.results.db_connection).toBeDefined();
      expect(body.results.cpu_usage).toBeDefined();
    });
  });

  describe('HTML response format', () => {
    it('should return HTML response when accept header includes text/html', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory usage is acceptable',
        value: '50%',
        time: 10,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            memory_usage: true,
          },
        }
      );

      expect(result.type).toBe('text/html');
      expect(result.body).toContain('<!DOCTYPE html>');
      expect(result.body).toContain('Health Check');
      expect(result.body).toContain('Memory usage is acceptable');
    });

    it('should display green banner for pass status', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory OK',
        value: '50%',
        time: 10,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            memory_usage: true,
          },
        }
      );

      expect(result.body).toContain('#4CAF50');
      expect(result.body).toContain("ðŸ‘Œ It's All Good");
    });

    it('should display yellow banner for warn status', async () => {
      (cpu.cpuCheck as jest.Mock).mockResolvedValue({
        componentName: 'cpu',
        status: Status.warn,
        message: 'CPU usage elevated',
        value: '75%',
        time: 15,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            cpu_usage: true,
          },
        }
      );

      expect(result.body).toContain('#FFC107');
      expect(result.body).toContain("âŒ Something's Wrong");
    });

    it('should display red banner for fail status', async () => {
      (disk.disk as jest.Mock).mockResolvedValue({
        componentName: 'disk',
        status: Status.fail,
        message: 'Disk space low',
        value: '95%',
        time: 20,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            disk_space: true,
          },
        }
      );

      expect(result.body).toContain('#F44336');
      expect(result.body).toContain("âŒ Something's Wrong");
    });

    it('should display check icons based on status', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory OK',
        value: '50%',
        time: 10,
      });

      (cpu.cpuCheck as jest.Mock).mockResolvedValue({
        componentName: 'cpu',
        status: Status.warn,
        message: 'CPU elevated',
        value: '75%',
        time: 15,
      });

      (disk.disk as jest.Mock).mockResolvedValue({
        componentName: 'disk',
        status: Status.fail,
        message: 'Disk low',
        value: '95%',
        time: 20,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            memory_usage: true,
            cpu_usage: true,
            disk_space: true,
          },
        }
      );

      expect(result.body).toContain('âœ…');
      expect(result.body).toContain('âš ï¸');
      expect(result.body).toContain('âŒ');
    });

    it('should sort checks alphabetically in HTML output', async () => {
      (disk.disk as jest.Mock).mockResolvedValue({
        componentName: 'disk',
        status: Status.pass,
        message: 'Disk OK',
        value: '60%',
        time: 20,
      });

      (cpu.cpuCheck as jest.Mock).mockResolvedValue({
        componentName: 'cpu',
        status: Status.pass,
        message: 'CPU OK',
        value: '45%',
        time: 15,
      });

      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory OK',
        value: '50%',
        time: 10,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            memory_usage: true,
            disk_space: true,
            cpu_usage: true,
          },
        }
      );

      const cpuIndex = result.body.indexOf('CPU OK');
      const diskIndex = result.body.indexOf('Disk OK');
      const memoryIndex = result.body.indexOf('Memory OK');

      expect(cpuIndex).toBeLessThan(diskIndex);
      expect(diskIndex).toBeLessThan(memoryIndex);
    });

    it('should not display value when it is "true" or "false"', async () => {
      (egress.egress as jest.Mock).mockResolvedValue({
        componentName: 'egress',
        status: Status.pass,
        message: 'Internet connectivity OK',
        value: 'true',
        time: 100,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            outbound_internet: true,
          },
        }
      );

      expect(result.body).toContain('Internet connectivity OK');
      expect(result.body).not.toContain('(true)');
    });

    it('should display value when it is not "true" or "false"', async () => {
      (memory.memoryCheck as jest.Mock).mockResolvedValue({
        componentName: 'memory',
        status: Status.pass,
        message: 'Memory OK',
        value: '50%',
        time: 10,
      });

      const result = await healthcheckHandler(
        { accept: 'text/html' },
        {
          checks: {
            memory_usage: true,
          },
        }
      );

      expect(result.body).toContain('(50%)');
    });

    it('should display execution time for each check', async () => {